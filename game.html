<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        * {
            box-sizing: border-box;
            font-family: Inter;
        }

        body {
            background: radial-gradient(circle at top, #090909, #000);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        .game {
            text-align: center;
        }

        .loader {
            width: 220px;
            height: 220px;
            position: relative;
        }

        svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        circle {
            fill: none;
            stroke: #111;
            stroke-width: 14;
        }

        #progress {
            stroke: gold;
            stroke-dasharray: 440;
            stroke-dashoffset: 440;
            transition: .15s linear;
        }

        .percent {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.3rem;
        }

        .result {
            display: none;
        }

        .result h2 {
            font-size: 2.6rem;
        }

        .result p {
            margin: 20px 0;
            font-size: 1.4rem;
        }

        button {
            padding: 14px 50px;
            border-radius: 50px;
            border: none;
            background: gold;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div class="game">
        <div class="loader">
            <svg viewBox="0 0 160 160">
                <circle cx="80" cy="80" r="70" />
                <circle cx="80" cy="80" r="70" id="progress" />
            </svg>
            <div class="percent">0%</div>
        </div>

        <div class="result">
            <h2 id="status"></h2>
            <p id="amount"></p>
            <button onclick="location.href='selectmise.html'">PLAY AGAIN</button>
        </div>
    </div>

    <script>
        firebase.initializeApp({
            apiKey: "AIzaSyDbQjciXp0J_UGQBBcqmjlCAemYK-tsR6c",
            authDomain: "am-wallet.firebaseapp.com",
            databaseURL: "https://am-wallet-default-rtdb.firebaseio.com",
            projectId: "am-wallet",
            storageBucket: "am-wallet.appspot.com",
            messagingSenderId: "877693231070",
            appId: "1:877693231070:web:47c59ac6220ed09af9c74f",
        });

        const auth = firebase.auth();
        const db = firebase.database();

        auth.onAuthStateChanged(user => {
            if (!user) { location.href = "login.html"; return; }
            startGame(user.uid);
        });

        function startGame(uid) {
            const bet = Number(localStorage.getItem("bet")) || 0;
            if (bet <= 0) { location.href = "selectmise.html"; return; }

            const userRef = db.ref("utilisateurs/" + uid);

            userRef.once("value").then(snap => {
                let u = snap.val() || {};
                u.ACCOUNTPRINCIPAL = u.ACCOUNTPRINCIPAL ?? 0;
                u.ACCOUNTGAMES = u.ACCOUNTGAMES ?? 0;
                u.gameSpendCounter = u.gameSpendCounter ?? 0;
                u.isVIP = u.isVIP ?? false;

                // ðŸ”¹ VÃ©rification du solde
                if (u.ACCOUNTPRINCIPAL < bet) {
                    alert("Solde insuffisant pour jouer !");
                    window.location.href = "selectmise.html";
                    return;
                }

                // ðŸ”¹ DÃ©bit immÃ©diat du compte principal
                u.ACCOUNTPRINCIPAL -= bet;

                // ðŸ”¹ Mise Ã  jour du compteur de dÃ©pense
                u.gameSpendCounter += bet;

                // ðŸ”¹ Calcul probabilitÃ©s progressives et gain
                let win = 0;
                const requiredSpend = bet * (u.isVIP ? 3 : 4);

                // ProbabilitÃ© progressive
                const progress = u.gameSpendCounter / requiredSpend;
                const baseChance = 0.1; // 10% min chance
                const chance = Math.min(baseChance + progress * 0.6, 0.85); // max 85%

                if (Math.random() < chance) {
                    // Multiplicateur variable
                    win = bet * pickMultiplier();
                    // reset compteur aprÃ¨s gain
                    u.gameSpendCounter = 0;
                }

                // ðŸ”¹ Mise Ã  jour Firebase
                userRef.update({
                    ACCOUNTPRINCIPAL: u.ACCOUNTPRINCIPAL,
                    ACCOUNTGAMES: u.ACCOUNTGAMES + win,
                    gameSpendCounter: u.gameSpendCounter
                });

                // ðŸ”¹ Animation loader
                animate(() => showResult(win));
            });
        }

        function pickMultiplier() {
            const pool = [
                { m: 1.2, w: 50 },
                { m: 1.5, w: 30 },
                { m: 2, w: 20 }
            ];
            let t = pool.reduce((s, o) => s + o.w, 0);
            let r = Math.random() * t;
            for (let o of pool) { if ((r -= o.w) <= 0) return o.m; }
            return 1.2;
        }

        function animate(done) {
            let p = 0;
            const percent = document.querySelector('.percent');
            const prog = document.getElementById('progress');
            const int = setInterval(() => {
                p++;
                percent.textContent = p + "%";
                prog.style.strokeDashoffset = 440 - (440 * p / 100);
                if (p >= 100) { clearInterval(int); setTimeout(done, 500); }
            }, 25);
        }

        function showResult(win) {
            document.querySelector('.loader').style.display = "none";
            const r = document.querySelector('.result');
            r.style.display = "block";
            document.getElementById('status').textContent = win > 0 ? "YOU WON" : "TRY AGAIN";
            document.getElementById('amount').textContent = win > 0 ? `+${win.toFixed(2)}$` : "No reward";
        }
    </script>

</body>

</html>