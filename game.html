<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Wheel Game Premium</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        * {
            box-sizing: border-box;
            font-family: Inter;
        }

        body {
            margin: 0;
            height: 100vh;
            overflow: hidden;
            background: radial-gradient(circle at top, #0b0b0b, #000);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        .game {
            text-align: center;
        }

        .wheel-wrapper {
            position: relative;
            width: 340px;
            height: 340px;
            margin: auto;
        }

        .pointer {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-top: 35px solid #ff2e2e;
            z-index: 50;
            filter: drop-shadow(0 0 10px red);
        }

        .outer-ring {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: radial-gradient(circle, #ffb400, #ff7b00);
            padding: 14px;
            box-shadow: 0 0 40px rgba(255, 140, 0, 0.6);
        }

        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            background: conic-gradient(#1e1e1e 0%,
                    #2a2a2a 9%,
                    #1e1e1e 18%,
                    #2a2a2a 27%,
                    #1e1e1e 36%,
                    #2a2a2a 45%,
                    #1e1e1e 54%,
                    #2a2a2a 63%,
                    #1e1e1e 72%,
                    #2a2a2a 81%,
                    #1e1e1e 90%,
                    #2a2a2a 100%);
        }

        .center {
            position: absolute;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: radial-gradient(circle, #111, #000);
            border: 4px solid gold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-weight: 700;
            box-shadow: 0 0 20px rgba(255, 200, 0, 0.7);
            text-align: center;
        }

        .center.win {
            animation: pulseWin 1s infinite;
            color: #00ff99;
        }

        .center.lose {
            animation: pulseLose 1s infinite;
            color: #ff4444;
        }

        @keyframes pulseWin {
            0% {
                box-shadow: 0 0 10px #00ff99;
            }

            50% {
                box-shadow: 0 0 35px #00ff99;
            }

            100% {
                box-shadow: 0 0 10px #00ff99;
            }
        }

        @keyframes pulseLose {
            0% {
                box-shadow: 0 0 10px red;
            }

            50% {
                box-shadow: 0 0 35px red;
            }

            100% {
                box-shadow: 0 0 10px red;
            }
        }

        .label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: 0 0;
            font-weight: 700;
            font-size: 14px;
            color: gold;
            text-shadow: 0 0 5px #000;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        button {
            margin-top: 25px;
            padding: 14px 60px;
            border-radius: 50px;
            border: none;
            background: linear-gradient(135deg, gold, orange);
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.6);
        }

        button:hover {
            transform: scale(1.05);
        }
    </style>
</head>

<body>

    <audio id="winSound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
    <audio id="loseSound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-game-over-213.wav"></audio>

    <div class="game">
        <div class="wheel-wrapper">
            <div class="pointer"></div>
            <div class="outer-ring">
                <div class="wheel" id="wheel">
                    <div class="center" id="centerText">
                        <div id="centerMain" class="win">1.0x</div>
                        <small id="centerSub" style="display: none;">Bonne chance</small>
                    </div>
                </div>
            </div>
        </div>
        <div style="display: flex;">
            <button onclick="location.href='game.html'" style="margin-right: 3px;">JOUER</button>
            <button onclick="location.href='selectmise.html'">NOUVELLE MISE</button>
        </div>

    </div>

    <script>
        firebase.initializeApp({
            apiKey: "AIzaSyDbQjciXp0J_UGQBBcqmjlCAemYK-tsR6c",
            authDomain: "am-wallet.firebaseapp.com",
            databaseURL: "https://am-wallet-default-rtdb.firebaseio.com",
            projectId: "am-wallet",
            storageBucket: "am-wallet.appspot.com",
            messagingSenderId: "877693231070",
            appId: "1:877693231070:web:47c59ac6220ed09af9c74f",
        });

        const auth = firebase.auth();
        const db = firebase.database();

        const wheel = document.getElementById("wheel");
        let centerText = document.getElementById("centerText");
        let centerMain = document.getElementById("centerMain");
        let centerSub = document.getElementById("centerSub");

        const winSound = document.getElementById("winSound");
        const loseSound = document.getElementById("loseSound");

        let currentRotation = 0;
        let centerRotation = 0;

        const multipliers = [1.1, 1.2, 1.3, 1.4, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2];

        function createWheelLabels(labels) {
            wheel.innerHTML = "";

            const center = document.createElement("div");
            center.className = "center";
            center.id = "centerText";

            const main = document.createElement("div");
            main.id = "centerMain";
            main.textContent = "1.0x";

            const sub = document.createElement("small");
            sub.id = "centerSub";

            center.appendChild(main);
            center.appendChild(sub);
            wheel.appendChild(center);

            centerText = center;
            centerMain = main;
            centerSub = sub;

            const segmentAngle = 360 / labels.length;
            labels.forEach((label, i) => {
                const div = document.createElement("div");
                div.className = "label";
                div.textContent = "x" + label;
                div.style.transform = `rotate(${segmentAngle * i + segmentAngle / 2}deg) translate(120px)`;
                wheel.appendChild(div);
            });
        }

        let counterInterval = null;
        function animateCenterCounter(finalMultiplier, duration, isWin) {
            if (counterInterval) clearInterval(counterInterval);

            let start = 1.0;
            let current = start;
            const startTime = performance.now();
            const pattern = Math.floor(Math.random() * 2);

            counterInterval = setInterval(() => {
                const now = performance.now();
                const progress = Math.min((now - startTime) / duration, 1);

                if (isWin) {
                    if (pattern === 0) {
                        if (progress < 0.4) current = start - 0.4 * (progress / 0.4);
                        else {
                            const t = (progress - 0.4) / 0.6;
                            current = (start - 0.4) + (finalMultiplier - (start - 0.4)) * t;
                        }
                    } else {
                        if (progress < 0.3) current = start + 0.6 * (progress / 0.3);
                        else if (progress < 0.6) current = (start + 0.6) - 0.8 * ((progress - 0.3) / 0.3);
                        else {
                            const t = (progress - 0.6) / 0.4;
                            current = (start - 0.2) + (finalMultiplier - (start - 0.2)) * t;
                        }
                    }
                } else {
                    if (progress < 0.5) current = start + 0.5 * (progress * 2);
                    else current = (start + 0.5) - 0.5 * ((progress - 0.5) * 2);
                }

                centerMain.textContent = current.toFixed(2) + "x";

                if (progress >= 1) {
                    clearInterval(counterInterval);
                    centerMain.textContent = finalMultiplier.toFixed(2) + "x";
                }
            }, 50);
        }

        function spinWheel(targetMultiplier, segments, done, isWin) {
            const index = segments.indexOf(targetMultiplier);
            if (index === -1) return;

            const segmentAngle = 360 / segments.length;
            const segmentCenter = index * segmentAngle + segmentAngle / 2;

            const spins = (6 + Math.floor(Math.random() * 4)) * 5;
            const finalRotation = spins * 360 + (360 - segmentCenter);
            const duration = 6500;
            const preStopDelay = duration - 950; // <-- 2 secondes avant la fin

            wheel.style.transition = "none";
            wheel.style.transform = `rotate(${currentRotation % 360}deg)`;
            centerText.style.transition = "none";
            centerText.style.transform = `translate(-50%, -50%) rotate(${centerRotation % 360}deg)`;

            wheel.offsetHeight;

            currentRotation += finalRotation;
            centerRotation -= finalRotation;

            wheel.style.transition = `transform ${duration}ms cubic-bezier(.12,.9,.18,1)`;
            centerText.style.transition = `transform ${duration}ms cubic-bezier(.12,.9,.18,1)`;

            wheel.style.transform = `rotate(${currentRotation}deg)`;
            centerText.style.transform = `translate(-50%, -50%) rotate(${centerRotation}deg)`;

            animateCenterCounter(targetMultiplier, duration, isWin);

            setTimeout(() => clearWheelLabels(), preStopDelay);

            setTimeout(done, duration + 100);
        }

        function clearWheelLabels() {
            document.querySelectorAll(".label").forEach(l => {
                l.style.opacity = "0";
                l.style.transform += " scale(0.5)";
                setTimeout(() => l.remove(), 500);
            });
        }

        function showCenterResult(win, multiplier) {
            clearWheelLabels();
            centerText.classList.remove("win", "lose");

            setTimeout(() => {
                if (win > 0) {
                    centerText.classList.add("win");
                    centerMain.textContent = "+" + win.toFixed(2) + "$";
                    centerSub.textContent = "x" + multiplier;
                    winSound.currentTime = 0;
                    winSound.play().catch(e => console.log("Win sound blocked", e));
                } else {
                    centerText.classList.add("lose");
                    centerMain.textContent = "PERDU";
                    centerSub.textContent = "x" + multiplier;
                    loseSound.currentTime = 0;
                    loseSound.play().catch(e => console.log("Lose sound blocked", e));
                }
                centerSub.style.display = "block";
            }, 300);
        }

        function pickMultiplier() {
            const pool = [
                { m: 1.1, w: 15 },
                { m: 1.2, w: 15 },
                { m: 1.3, w: 12 },
                { m: 1.4, w: 12 },
                { m: 1.5, w: 10 },
                { m: 1.6, w: 8 },
                { m: 1.7, w: 7 },
                { m: 1.8, w: 6 },
                { m: 1.9, w: 4 },
                { m: 2.0, w: 3 }
            ];

            let t = pool.reduce((s, o) => s + o.w, 0);
            let r = Math.random() * t;
            for (let o of pool) if ((r -= o.w) <= 0) return o.m;
            return 1.1;
        }

        auth.onAuthStateChanged(user => {
            if (!user) location.href = "login.html";
            else startGame(user.uid);
        });

        function startGame(uid) {
            const bet = Number(localStorage.getItem("bet")) || 0;
            if (bet <= 0) return location.href = "selectmise.html";

            const ref = db.ref("utilisateurs/" + uid);

            ref.once("value").then(snap => {
                let u = snap.val() || {};
                u.ACCOUNTPRINCIPAL ??= 0;
                u.ACCOUNTGAMES ??= 0;
                u.gameSpendCounter ??= 0;
                u.isVIP ??= false;

                if (u.ACCOUNTPRINCIPAL < bet) {
                    alert("Solde insuffisant");
                    return location.href = "selectmise.html";
                }

                u.ACCOUNTPRINCIPAL -= bet;
                u.gameSpendCounter += bet;

                let win = 0;
                const required = bet * (u.isVIP ? 3 : 4);
                const chance = Math.min(0.1 + (u.gameSpendCounter / required) * 0.6, 0.85);

                let multiplier = 1.1;
                if (Math.random() < chance) {
                    multiplier = pickMultiplier();
                    win = bet * multiplier;
                    u.gameSpendCounter = 0;
                }

                ref.update({
                    ACCOUNTPRINCIPAL: u.ACCOUNTPRINCIPAL,
                    ACCOUNTGAMES: u.ACCOUNTGAMES + win,
                    gameSpendCounter: u.gameSpendCounter
                });

                createWheelLabels(multipliers);

                spinWheel(multiplier, multipliers, () => {
                    showCenterResult(win, multiplier);
                }, win > 0);
            });
        }
    </script>

</body>

</html>