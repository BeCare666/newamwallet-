<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Crash Game Ultra Premium</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Police moderne -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        /* üåë Fond g√©n√©ral et typographie */
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at center, #0a0a0a, #1a1a1a);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: #fff;
        }

        /* üé® Canvas premium avec ombre et arrondi */
        #crashCanvas {
            border-radius: 12px;
            background: linear-gradient(180deg, #111, #1a1a1a);
            width: 95%;
            max-width: 700px;
            height: 50%;
            display: block;
            margin: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        /* ‚ú® Multiplicateur premium */
        .multiplier-display {
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem;
            font-weight: 900;
            color: #FFD700;
            letter-spacing: 1px;
            text-shadow: 0 0 12px #FFD700, 0 0 25px #FFED66, 0 0 40px #FFD700AA;
            transition: all 0.3s ease-out;
            z-index: 10;
        }

        /* üèÜ R√©sultat en card glassmorphism moderne */
        .result-box {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.06);
            border-radius: 15px;
            padding: 25px 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7);
            margin-top: 25px;
            transition: transform 0.3s, opacity 0.3s;
            text-align: center;
            max-width: 400px;
        }

        .result-box h2 {
            font-size: 2rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: #fff;
        }

        .result-box h2 span {
            display: inline-block;
            transition: transform 0.4s ease;
        }

        .result-box p {
            font-size: 1.6rem;
            color: #FFD700;
            font-weight: 700;
            text-shadow: 0 0 10px #FFD700;
        }

        /* üïπÔ∏è Bouton premium rond avec effet hover */
        button {
            padding: 14px 45px;
            border-radius: 50px;
            border: none;
            background: linear-gradient(145deg, #FFD700, #FFC107);
            color: #000;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 8px 18px rgba(255, 215, 0, 0.6);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        button:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 28px rgba(255, 215, 0, 0.8);
        }

        /* ‚ú® Particules glow premium */
        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            width: 6px;
            height: 6px;
            background: #FFD700;
            box-shadow: 0 0 6px #FFD700, 0 0 12px #FFED66, 0 0 18px #FFD700AA;
        }

        /* üî• Avion SVG glow */
        #plane {
            position: absolute;
            width: 28px;
            height: 28px;
            pointer-events: none;
            filter: drop-shadow(0 0 15px #FFAA00);
            transition: transform 0.1s linear;
            z-index: 5;
        }

        /* Trailing glow */
        #trail {
            position: absolute;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            pointer-events: none;
            background: radial-gradient(circle, #FFD700 0%, transparent 80%);
            filter: blur(10px);
            z-index: 4;
        }

        /* üîî Animations de glow suppl√©mentaires */
        #crashCanvas:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: 0 0 80px rgba(255, 215, 0, 0.2) inset;
            pointer-events: none;
            border-radius: 12px;
        }
    </style>
</head>

<body>
    <span id="x" onclick="location.href='selectmise.html'"
        style="position: fixed; top: 5px;; right: 5px; color: white; font-weight: bold;">X</span>
    <canvas id="crashCanvas"></canvas>
    <img src="https://cdn-icons-png.flaticon.com/512/681/681494.png" id="plane" />
    <div id="trail"></div>

    <div class="multiplier-display" id="multiplierDisplay">x1.00</div>

    <div class="result-box">
        <h2 id="status"><span id="iconResult">üéÆ</span> Crash Game</h2>
        <p id="amount"></p>
        <button onclick="location.reload()">JOUER ENCORE</button>
    </div>

    <!-- üîä Sons -->
    <audio id="audioGain" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
    <audio id="audioLoss" src="https://actions.google.com/sounds/v1/cartoon/boing.ogg"></audio>
    <audio id="audioTick" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

    <script>
        // üî• Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyDbQjciXp0J_UGQBBcqmjlCAemYK-tsR6c",
            authDomain: "am-wallet.firebaseapp.com",
            databaseURL: "https://am-wallet-default-rtdb.firebaseio.com",
            projectId: "am-wallet",
            storageBucket: "am-wallet.appspot.com",
            messagingSenderId: "877693231070",
            appId: "1:877693231070:web:47c59ac6220ed09af9c74f",
        });

        const auth = firebase.auth();
        const db = firebase.database();
        const canvas = document.getElementById('crashCanvas');
        const ctx = canvas.getContext('2d');
        const plane = document.getElementById('plane');
        const trail = document.getElementById('trail');

        let width = canvas.width = canvas.offsetWidth;
        let height = canvas.height = canvas.offsetHeight;

        let bet = 0;
        let targetMultiplier = 1;
        let progress = 0;
        let animationRunning = false;

        const audioGain = document.getElementById('audioGain');
        const audioLoss = document.getElementById('audioLoss');
        const audioTick = document.getElementById('audioTick');

        let particles = [];

        function pickMultiplier() {
            const pool = [{ m: 1.2, w: 50 }, { m: 1.5, w: 30 }, { m: 2, w: 20 }];
            let t = pool.reduce((s, o) => s + o.w, 0);
            let r = Math.random() * t;
            for (let o of pool) if ((r -= o.w) <= 0) return o.m;
            return 1.2;
        }

        function spawnParticles(x, y) {
            for (let i = 0; i < 15; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 3,
                    vy: -Math.random() * 4 - 1,
                    alpha: 1,
                    size: Math.random() * 3 + 2
                });
            }
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255,215,0,${p.alpha})`;
                ctx.fill();
                p.x += p.vx;
                p.y += p.vy;
                p.alpha -= 0.02;
            });
            particles = particles.filter(p => p.alpha > 0);
        }

        function drawCurve(currentMultiplier) {
            ctx.clearRect(0, 0, width, height);
            ctx.lineWidth = 4;
            ctx.strokeStyle = "#FFD700";
            ctx.beginPath();
            ctx.moveTo(0, height);

            for (let x = 0; x <= width; x++) {
                let t = x / width;
                let yMult = 1 + (targetMultiplier - 1) * Math.pow(t, 1.8);
                let y = height - (yMult / 3) * height;
                ctx.lineTo(x, y);
            }
            ctx.stroke();

            let planeX = Math.min(Math.floor(progress * width), width - 1);
            let planeY = height - (currentMultiplier / 3) * height;
            ctx.beginPath();
            ctx.arc(planeX, planeY, 10, 0, Math.PI * 2);
            ctx.fillStyle = "red";
            ctx.fill();

            plane.style.left = planeX - 14 + "px";
            plane.style.top = planeY - 14 + "px";
            trail.style.left = planeX - 14 + "px";
            trail.style.top = planeY - 14 + "px";

            drawParticles();
            document.getElementById('multiplierDisplay').textContent = 'x' + currentMultiplier.toFixed(2);
        }

        function animate() {
            if (!animationRunning) return;
            progress += 0.005;
            let easedProgress = Math.pow(progress, 1.8);
            let currentMultiplier = 1 + (targetMultiplier - 1) * easedProgress;
            if (currentMultiplier > targetMultiplier) currentMultiplier = targetMultiplier;

            drawCurve(currentMultiplier);

            if (currentMultiplier < targetMultiplier) {
                if (progress % 0.05 < 0.01) audioTick.play();
                requestAnimationFrame(animate);
            } else {
                animationRunning = false;
                if (targetMultiplier > 1) {
                    audioGain.play();
                    spawnParticles(width / 2, height * (1 - currentMultiplier / 3));
                    document.getElementById('iconResult').textContent = 'üèÜ';
                } else {
                    audioLoss.play();
                    document.getElementById('iconResult').textContent = 'üí•';
                }
                showResult((targetMultiplier - 1) * bet);
            }
        }

        function showResult(win) {
            document.getElementById('status').textContent = win > 0 ? "FELICITATIONS" : "ESSAYEZ ENCORE";
            document.getElementById('amount').textContent = win > 0 ? `+${win.toFixed(2)}$` : "Aucune r√©compense";
        }

        auth.onAuthStateChanged(user => {
            if (!user) location.href = 'login.html';
            else startGame(user.uid);
        });

        function startGame(uid) {
            bet = Number(localStorage.getItem("bet")) || 0;
            if (bet <= 0) return location.href = 'selectmise.html';

            const ref = db.ref("utilisateurs/" + uid);
            ref.once("value").then(snap => {
                let u = snap.val() || {};
                u.ACCOUNTPRINCIPAL ??= 0;
                u.ACCOUNTGAMES ??= 0;
                u.gameSpendCounter ??= 0;
                u.isVIP ??= false;

                if (u.ACCOUNTPRINCIPAL < bet) { alert("Solde insuffisant"); return location.href = 'selectmise.html'; }

                u.ACCOUNTPRINCIPAL -= bet;
                u.gameSpendCounter += bet;

                const required = bet * (u.isVIP ? 3 : 4);
                const chance = Math.min(0.1 + (u.gameSpendCounter / required) * 0.6, 0.85);

                let win = 0;
                if (Math.random() < chance) {
                    targetMultiplier = pickMultiplier();
                    win = bet * targetMultiplier;
                    u.gameSpendCounter = 0;
                } else {
                    targetMultiplier = 1;
                }

                ref.update({
                    ACCOUNTPRINCIPAL: u.ACCOUNTPRINCIPAL,
                    ACCOUNTGAMES: u.ACCOUNTGAMES + win,
                    gameSpendCounter: u.gameSpendCounter
                });

                progress = 0;
                animationRunning = true;
                animate();
            });
        }
    </script>
</body>

</html>